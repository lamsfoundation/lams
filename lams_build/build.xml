<?xml version="1.0" encoding="UTF-8"?>

<project name="LAMS-Build" default="usage" basedir=".">

	<!-- import properties from the shared and o/s specific files -->
	<property file="common.properties" />
	<property file="shared.properties" />
	<property file="${osPropertiesName}.properties" />

	<target name="init">
		<mkdir dir="${assembly}" />
	</target>

	<target name="usage" description="print usage message">
		<echo>------------ Utility Methods ------------------------</echo>
		<echo>usage: this message</echo>
		<echo>clean: clean the ear assembly directories</echo>
		<echo>clean-subprojects: clean sub project build directories</echo>
		<echo>build-subprojects: build sub projects</echo>
		<echo>build-tool-deploy-utility: build the tool_deploy utility and update copy in lams_build</echo>
		<echo>------------ Build/Deploy LAMS  ------------------------</echo>
		<echo>assemble-ear: assemble ear structure</echo>
		<echo>deploy-ear: copy ear to local jboss server</echo>
		<echo>copyfiles: copy configuration files to local jboss server</echo>
		<echo>----------------------------------------------------------</echo>
		<echo>To deploy LAMS:</echo>
		<echo>   1. copyfiles (this only needs to be done once, or when basic configuration the files change)</echo>
		<echo>   2. assemble-ear</echo>
		<echo>   3. manually refresh the project</echo>
		<echo>   4. deploy-ear</echo>
		<echo>   5. deploy-tools</echo>
		<echo>Do not try to assemble and deploy in the same run - if you do,</echo>
		<echo>Eclipse may not deploy all of the newly created files.</echo>
	</target>

	<!-- clean dirs for this script only -->
	<target name="clean" description="cleans assembly">
		<delete dir="${assembly}"
			includes="**/*" />
	</target>

	<!-- clean all projects -->
	<target name="clean-subprojects" description="cleans sub projects" />


	<!-- build sub-projects -->
	<target name="build-subprojects"
		description="builds sub porjects">
		<ant antfile="../${lams_common}/build.xml" target="build-jar"
			inheritAll="false" />
		<ant antfile="../${lams_contentrepository}/build.xml"
			target="build-jar" inheritAll="false" />
		<ant antfile="../${lams_central}/build.xml" target="build-war"
			inheritAll="false" />
		<ant antfile="../${lams_learning}/build.xml" target="build-war" inheritAll="false"/>
		<ant antfile="../${lams_monitoring}/build.xml"  target="build-war" inheritAll="false"/>
		<ant antfile="../${lams_admin}/build.xml" target="build-war" inheritAll="false"/>
	</target>

	<!-- build tool deployment utility -->
	<target name="build-tool-deploy-utility"
		description="builds the tool deploy utility and copy to lams_build">

		<ant antfile="../${lams_tool_deploy}/build.xml" target="build"
			inheritAll="false" />

		<mkdir dir="${deploy.tool}" />
		<mkdir dir="${deploy.tool}/lib" />
		
		<copy todir="${deploy.tool}" overwrite="yes" flatten="true">
			<fileset dir="../${lams_tool_deploy}">
				<include name="deploy.bat" />
				<include name="deploy.sh" />
			</fileset>
		</copy>

		<copy todir="${deploy.tool}/lib" overwrite="yes" flatten="true">
			<fileset dir="../${lams_tool_deploy}/lib">
				<include name="jakarta-commmons/*.jar" />
				<include name="mysql/*.jar" />
				<include name="xstream/*.jar" />
			</fileset>
		</copy>
		
		<copy todir="${deploy.tool}/lib" overwrite="yes" flatten="true">
			<fileset dir="../${lams_tool_deploy}/build/lib">
				<include name="lams-tool-deploy.jar" />
			</fileset>
		</copy>
		
	</target>

	<!-- cruise control task : build lams -->
	<target name="lams-cruise" depends="assemble-ear, rebuild-db, deploy-ear, deploy-tools, copyfiles" description="builds entire LAMS (used for CruiseControl instance)"> 
		<echo>Building LAMS using CruiseControl</echo>
	</target>
	
	<!-- assemble ear -->
	<target name="assemble-ear" depends="init, clean, build-subprojects"
		description="Assemble lams ear in exploded form">
		<!-- have to copy the libs etc. to a temp location otherwise we end up with all the directories under lib as well-->
		<mkdir dir="${assembly}/temp" />
		<copy todir="${assembly}/temp" failonerror="true"
			flatten="true">
			<fileset dir="${lib}">
				<patternset id="lib.jars">
					<!--  the desired jars are nominated explicitly so -->
					<!--  we don't release a build only one by accident -->
					<include name="aopalliance/*.jar" />
					<include name="cglib/*.jar" />
					<include name="dom4j/*.jar" />
					<include name="ehcache/*.jar" />
					<include name="fckeditor/*.jar" />
					<include name="hibernate/*.jar" />
					<include name="j2ee/*.jar" />
					<include name="jakarta-commons/*.jar" />
					<include name="jakarta-poi/*.jar" />
					<include name="jakarta-taglibs/*.jar" />
					<include name="jboss/*.jar" />
					<include name="jdom/*.jar" />
					<include name="jfreechart/*.jar" />
					<include name="log4j/*.jar" />
					<include name="mysql/*.jar" />
					<include name="odmg/*.jar" />
					<include name="quartz/*.jar" />
					<include name="spring/*.jar" />
					<include name="struts/*.jar" />
					<include name="wddx/*.jar" />
					<include name="concurrent/*.jar" />					
				</patternset>
			</fileset> 
			<fileset dir="..">
				<include name="${lams_common}/${sub.build.lib}/*.jar" />
				<include name="${lams_contentrepository}/${sub.build.lib}/*.jar" />
				<include name="${lams_central}/${sub.build.lib}/*.war" />
				<include name="${lams_central}/${sub.build.lib}/*.jar" />
				<include name="${lams_monitoring}/${sub.build.lib}/*.jar"/>
				<include name="${lams_monitoring}/${sub.build.lib}/*.war"/>
				<include name="${lams_learning}/${sub.build.lib}/*.jar"/>
				<include name="${lams_learning}/${sub.build.lib}/*.war"/>
				<include name="${lams_admin}/${sub.build.lib}/*.jar"/>
				<include name="${lams_admin}/${sub.build.lib}/*.war"/>
			</fileset>
		</copy> 
		<!-- Pull out all the language files -->
		<mkdir dir="${assembly}/temp/lams-dictionary.jar" />
		<copy todir="${assembly}/temp/lams-dictionary.jar" failonerror="true">
			<fileset dir="../${lams_common}/${sub.build.language}"><include name="**" /></fileset>
			<fileset dir="../${lams_contentrepository}/${sub.build.language}"><include name="**" /></fileset> 
			<fileset dir="../${lams_central}/${sub.build.language}"><include name="**" /></fileset>
			<fileset dir="../${lams_monitoring}/${sub.build.language}"><include name="**" /></fileset>
			<fileset dir="../${lams_learning}/${sub.build.language}"><include name="**" /></fileset>
			<fileset dir="../${lams_admin}/${sub.build.language}"><include name="**" /></fileset>
		</copy>
		<!-- create a temporary ear -->
		<ear destfile="${assembly.temp.ear}" compress="false"
			appxml="${app.xml}">
			<fileset dir="${assembly}/temp" includes="**" />
		</ear>
		<!-- remove temp lib -->
<!--		<delete dir="${assembly}/temp" includeEmptyDirs="true" /> -->
		<!-- explode the ear (Why doesn't the EAR task support exploded format?) -->
		<unjar src="${assembly.temp.ear}" dest="${assembly.lams.ear}" />
		<!-- delete temp.ear -->
		<delete file="${assembly.temp.ear}" />
	</target>

	<!-- ============================================================================== -->
	<!-- Deploy the ear file to the server                                              -->
	<!-- ============================================================================== -->

	<target name="deploy-ear" 
		description="Deploys previously assembled ear to jboss">
		<copy todir="${jboss.ear.deploy}" overwrite="true"
			failonerror="true" verbose="true">
			<fileset dir="${assembly}">
				<include name="${lams.ear}/**/*.*" />
			</fileset>

		</copy>
	</target>

	<!-- ============================================================================== -->
	<!-- Deploy IMS Content Package tool to the depoloyed ear 							-->
	<!--  Relies on the tools using the parameter jboss.deploy							-->						
	<!-- ============================================================================== -->
	<target name="deploy-tools" description="Deploy the tools, including any special parallel activities">
 		<ant antfile="../${tool_forum_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant>
<!--		<ant antfile="../${tool_imscp_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant>-->
		<ant antfile="../${tool_lamc_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant> 
		<ant antfile="../${tool_lanb_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant>
		<ant antfile="../${tool_laqa_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant>
		<ant antfile="../${tool_sbmt_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant>
<!--		<ant antfile="../${tool_survey_dir}/build.xml" target="deploy-tool"
				inheritAll="false" >
			<property name="jboss.deploy" location="${jboss.deploy}"/>
		</ant> -->
		<ant target="deploy-learning-libraries"/>
	</target>
	
	<!-- ============================================================================== -->
	<!--  Rebuild the LAMS Database														-->						
	<!-- ============================================================================== -->
	<target name="rebuild-db" description="Rebuild the LAMS Database.">
		<ant antfile="../${lams_common}/build.xml" target="rebuild-db" inheritAll="false" />
	</target>
	
	<!-- ============================================================================== -->
	<!-- Copy the third party jar files and cofiguration files for deployment           -->
	<!-- ============================================================================== -->
	<target name="makeconfdir">
		<delete quiet="true">
			<fileset dir="${lamsconf}" />
		</delete>
		<mkdir dir="${lamsconf}" />
	</target>

	<target name="copyfiles" depends="makeconfdir"
		description="copy lib and config files">
		<copy overwrite="yes" todir="${jboss.server.instance}/conf/">
			<fileset dir="${conf.jboss}/">
				<include name="login-config.xml" />
				<include name="log4j.xml" />
				<include name="jboss-service.xml" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${lamsconf}">
			<fileset dir="${conf.auth}/">
				<include name="*.xml" />
				<include name="*.dtd" />
			</fileset>
			<fileset dir="${conf.lams}/">
				<include name="*.xml" />
				<include name="*.dtd" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${jboss.ear.deploy}">
			<fileset dir="${conf.jboss}/service">
				<include name="mysql*.xml" />
				<include name="local-service.xml" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${jboss.ear.deploy}/jbossweb-tomcat55.sar/META-INF">
			<fileset dir="${conf.jboss}/tomcat">
				<include name="jboss-service.xml" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${jboss.ear.deploy}/jbossweb-tomcat55.sar/">
			<fileset dir="${conf.jboss}/tomcat">
				<include name="server.xml" />
				<include name="context.xml" />
			</fileset>
		</copy>
		<ant antfile="../${lams_common}/build.xml" target="copy-shared-session-jar" inheritAll="false"/>
		<echo message="Please copy jboss-cache.jar and jgroups.jar from server/all/lib to server/default/lib"
			level="warning"/>
	</target>

	<target name="test-report" description="Run all the test cases across the system. Takes a long time.">
		<!-- Core projects first -->
<!-- 		<ant antfile="../${lams_common}/build.xml" target="insert-test-data" inheritAll="false"/>
 		<ant antfile="../${lams_common}/build.xml" target="test-report" inheritAll="false"/>
 		<ant antfile="../${lams_contentrepository}/build.xml" target="test-report" inheritAll="false"/>
 		<ant antfile="../${lams_common}/build.xml" target="insert-test-data" inheritAll="false"/>
		<ant antfile="../${lams_central}/build.xml" target="test-report" inheritAll="false"/>
-->
 		<ant antfile="../${lams_common}/build.xml" target="insert-test-data" inheritAll="false"/>
 		<ant antfile="../${tool_survey_dir}/build.xml" target="build-db" inheritAll="false"/> 
<!--  		<ant antfile="../${tool_survey_dir}/build.xml" target="build-jar" inheritAll="false"/>  -->
		<ant antfile="../${lams_monitoring}/build.xml" target="test" inheritAll="false"/> 
<!-- 		<ant antfile="../${lams_learning}/build.xml" target="test-report" inheritAll="false"/> -->

		<!--  Now the tools -->
<!-- 		<ant antfile="../${lams_common}/build.xml" target="insert-test-data" inheritAll="false"/>
		<ant antfile="../${tool_forum_dir}/build.xml" target="test-report" inheritAll="false"/>
		<ant antfile="../${tool_imscp_dir}/build.xml" target="test-report" inheritAll="false"/>
		<ant antfile="../${tool_laqa_dir}/build.xml" target="test-report" inheritAll="false"/>
		<ant antfile="../${tool_lanb_dir}/build.xml" target="test-report" inheritAll="false"/>
		<ant antfile="../${tool_sbmt_dir}/build.xml" target="test-report" inheritAll="false"/>
		<ant antfile="../${tool_survey_dir}/build.xml" target="test-report" inheritAll="false"/>
	-->
	</target>
	
	
	<!-- Build the parallel activities and other complex activities. Must be done after -->
	<!-- the tools are deployed -->
	
	<!-- Generate the deployment package for nb/submit parallel activity. -->
	<target name="create-nbsubmit-deploy-package-library" depends="">

			<path id="deploy.lib.classpath">
				<fileset dir="${deploy.tool.dir}">
					<include name="lib/*.jar"/>
				</fileset>
			</path> 
				  
			<property name="assembly.activity" value="${basedir}/assembly/nbsubmit"/>
			<property name="package.cfg" value="librarypackages/nbsubmit"/>
		
			<mkdir dir="${assembly.activity}/"/>
			<mkdir dir="${assembly.activity}/lib"/> 
			<mkdir dir="${assembly.activity}/sql"/> 
			<mkdir dir="${assembly.activity}/language"/> 
		
			<copy overwrite="yes" todir="${assembly.activity}/sql">
				<fileset dir="${package.cfg}">
					<include name="learninglibrary1_insert.sql"/>
					<include name="libraryActivity1_insert.sql"/>
					<include name="toolActivity1_insert.sql"/>
					<include name="toolActivity2_insert.sql"/>
				</fileset>
			</copy>

		   <copy overwrite="yes" file="${package.cfg}/deployLibrary.xml"
					   	tofile="${assembly.activity}/deploy.xml" >
			  <!-- replace @assemblydir@ in the xml template - this allows it to run under any directory structure -->
		        <filterchain>
		            <striplinecomments>
		               <comment value="!"/>
		            </striplinecomments>
		           <replacetokens>
		                <token key="assemblydir" value="${assembly.activity}/sql"/>
		            </replacetokens>
		            <replacetokens>
			             <token key="lamsear" value="${jboss.ear.deploy}"/>
			        </replacetokens>
		        </filterchain>
		    </copy>

			<copy overwrite="yes" todir="${assembly.activity}/lib">
				<fileset dir="${deploy.tool.dir}/lib">
					<include name="*.jar"/>
				</fileset>
			</copy>

			<taskdef name="generateDeployLibraryProperties" 
				classname="org.lamsfoundation.lams.tool.deploy.libraryActivity.CreateLibraryPackageTask">
			    <classpath refid="deploy.lib.classpath"/>
			</taskdef>

			<generateDeployLibraryProperties depends="compile" 
				mode="development" 
				outputPath="${assembly.activity}"
				configFile="${assembly.activity}/deploy.xml"
				dbPassword="${db.password}"
				dbUsername="${db.username}"
				dbDriverUrl="${db.url}"
				dbDriverClass="com.mysql.jdbc.Driver"	
				/>
		
		
		</target>

		<!-- deploy the complex activities to the library -->
		<target name="deploy-learning-libraries" depends="create-nbsubmit-deploy-package-library">

				<path id="deploy.classpath">
					<fileset dir="${assembly.activity}">
						<include name="lib/*.jar"/>
					</fileset>
				</path> 

				<echo>Deploying Library Activities</echo>
		
				<java
					classname="org.lamsfoundation.lams.tool.deploy.libraryActivity.DeployLibrary"
					classpathref="deploy.classpath"
					fork="true">
						<arg file="${assembly.activity}/deploy.xml"/>
						<arg file="${assembly.activity}/language"/>
				</java>
							
			</target>
</project>
